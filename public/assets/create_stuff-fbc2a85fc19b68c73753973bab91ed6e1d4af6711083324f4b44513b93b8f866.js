function checkNav(e,t){for(var o=!1,a=0;a<stuff_picker.length;a++)"TYPE"==stuff_picker[a].stuff_type_name&&(o=!0);"TYPE"==e&&(o=!0),$(".cursor-arrow[value='"+current_type_id+"']").parent().removeClass("active"),o?(current_type_id=t,openNav(e,t)):$("#type_first").modal("show"),$(".cursor-arrow[value='"+current_type_id+"']").parent().addClass("active")}function stuffColorSelect(e,t){t!=-99&&$.ajax({url:"/api/v1/creates/stuff_color",type:"get",dataType:"json",data:{type_id:e,stuff_id:t},success:function(t){if(document.getElementById("color-picker").innerHTML="",document.getElementById("color-picker-2").innerHTML="",document.getElementById("color-picker-3").innerHTML="",t.data.length>0&&t.color1){$("#color-picker-render-label").show(),$("#color-picker-render-1").show();for(var o=0;o<t.data.length;o++)$("#color-picker").append("<div class='create-circle-color' onclick='setStuffTypeColor("+t.data[o].id+",0,"+e+","+!0+")' value="+t.data[o].id+"></div>"),$(".create-circle-color[value='"+t.data[o].id+"']").css("background-color",t.data[o].color_code)}else $("#color-picker-render-label").hide(),$("#color-picker-render-1").hide();if(t.layer_two.length>0&&t.color2){$("#color-picker-render-2").show();for(var o=0;o<t.layer_two.length;o++)$("#color-picker-2").append("<div class='create-circle-color ' onclick='setStuffTypeColor("+t.layer_two[o].id+",1,"+e+","+!0+")' value="+t.layer_two[o].id+"></div>"),$(".create-circle-color[value='"+t.layer_two[o].id+"']").css("background-color",t.layer_two[o].color_code)}else $("#color-picker-render-2").hide();if(t.layer_three.length>0&&t.color3){$("#color-picker-render-3").show();for(var o=0;o<t.layer_three.length;o++)$("#color-picker-3").append("<div class='create-circle-color ' onclick='setStuffTypeColor("+t.layer_three[o].id+",2,"+e+","+!0+")' value="+t.layer_three[o].id+"></div>"),$(".create-circle-color[value='"+t.layer_three[o].id+"']").css("background-color",t.layer_three[o].color_code)}else $("#color-picker-render-3").hide()},error:function(e){console.log(e)}})}function openNav(e,t){stuffColorChangeBtn(0,t),stuffColorChangeBtn(1,t),stuffColorChangeBtn(2,t),$("#subBarMenu").empty(),$.ajax({url:"/api/v1/creates/subBarClick",type:"get",dataType:"json",data:{type_id:t},success:function(o){if("TYPE"!=e||"ARM"!=e||"BOTTOM"!=e||"LOGO"!=e)for(var a=-99,r=0;r<stuff_picker.length;r++)if(stuff_picker[r].type_id==t){a=stuff_picker[r].stuff_id,stuffColorSelect(t,a);break}if(o.data.length>0){o.data.sort(function(e,t){return parseFloat(t.priority)-parseFloat(e.priority)}),"TYPE"!=o.data[0].type&&"NECK"!=o.data[0].type&&"BODY"!=o.data[0].type&&"PLACKET"!=o.data[0].type&&"ARM"!=o.data[0].type&&$("#subBarMenu").append("<div class='row staff-item' onclick='resetSubBar("+t+","+!0+")'><div class='stuff-side-padding'><div class='create-tooltips' data-tmp-balloon='\u0e25\u0e1a'  data-tmp-balloon-pos='top'><div class='stuff-pick-empty stuff-circle-hover'><i class='glyphicon glyphicon-ban-circle'></i></div></div></div></div>");for(var r=0;r<o.data.length;r++){for(var i=-99,c=!1,l="",_=[],s=0;s<stuff_picker.length;s++)"TYPE"==stuff_picker[s].stuff_type_name&&(i=stuff_picker[s].stuff_id),"POCKET"==stuff_picker[s].stuff_type_name&&(c=!0,"POCKET_1_LEFT"==stuff_picker[s].stuff_name||"POCKET_2_LEFT"==stuff_picker[s].stuff_name?l="left":"POCKET_1_RIGHT"!=stuff_picker[s].stuff_name&&"POCKET_2_RIGHT"!=stuff_picker[s].stuff_name||(l="right")),_.push(stuff_picker[s].stuff_id);var n;n=_.indexOf(o.data[r].id)==-1?"row staff-item":"row staff-item active",""!=o.data[r].belong_to_type?o.data[r].belong_to_type==i&&$("#subBarMenu").append("<div id='stuff_"+o.data[r].id+"' class='"+n+"' onclick='stuff_click("+o.data[r].id+",true)'><div class='stuff-side-padding' ><div class='create-tooltips' data-tmp-balloon='"+o.data[r].desc+"' data-tmp-balloon-pos='up'><img class='stuff-side-img stuff-side-circle stuff-circle-hover' src='"+o.data[r].img+"' alt='"+o.data[r].name+"'>"+o.data[r].desc+"</div></div></div>"):c?"left"==l?(console.log("LOGO LEFT"),"logo_front_l"!=o.data[r].name&&"logo_top_pocket_r"!=o.data[r].name&&"logo_center_pocket_r"!=o.data[r].name&&$("#subBarMenu").append("<div id='stuff_"+o.data[r].id+"' class='"+n+"' onclick='stuff_click("+o.data[r].id+",true)'><div class='stuff-side-padding' ><div class='create-tooltips' data-tmp-balloon='"+o.data[r].desc+"' data-tmp-balloon-pos='up'><img class='stuff-side-img stuff-side-circle stuff-circle-hover' src='"+o.data[r].img+"' alt='"+o.data[r].name+"'>"+o.data[r].desc+"</div></div></div>")):"right"==l&&(console.log("LOGO RIGHT"),"logo_front_r"!=o.data[r].name&&"logo_top_pocket"!=o.data[r].name&&"logo_center_pocket"!=o.data[r].name&&$("#subBarMenu").append("<div id='stuff_"+o.data[r].id+"' class='"+n+"' onclick='stuff_click("+o.data[r].id+",true)'><div class='stuff-side-padding' ><div class='create-tooltips' data-tmp-balloon='"+o.data[r].desc+"' data-tmp-balloon-pos='up'><img class='stuff-side-img stuff-side-circle stuff-circle-hover' src='"+o.data[r].img+"' alt='"+o.data[r].name+"'>"+o.data[r].desc+"</div></div></div>")):"logo_top_pocket"!=o.data[r].name&&"logo_center_pocket"!=o.data[r].name&&"logo_center_pocket_r"!=o.data[r].name&&"logo_center_pocket_r"!=o.data[r].name&&$("#subBarMenu").append("<div id='stuff_"+o.data[r].id+"' class='"+n+"' onclick='stuff_click("+o.data[r].id+",true)'><div class='stuff-side-padding' ><div class='create-tooltips' data-tmp-balloon='"+o.data[r].desc+"' data-tmp-balloon-pos='up'><img class='stuff-side-img stuff-side-circle stuff-circle-hover' src='"+o.data[r].img+"' alt='"+o.data[r].name+"'>"+o.data[r].desc+"</div></div></div>")}$("#subBarMenu").append("<div class='row' style='margin-bottom: 93px'></div>")}document.getElementById("subSlideBar").style.width="110px"},error:function(e){console.log("API subBarClick ERROR !!"),console.log(e)}})}function resetSubBar(e,t){for(var o=0;o<stuff_picker.length;o++)if(stuff_picker[o].type_id==e){if("POCKET"==stuff_picker[o].stuff_type_name)for(var a=0;a<stuff_picker.length;a++)"LOGO"==stuff_picker[a].stuff_type_name&&stuff_picker.splice(a,1);stuff_picker.splice(o,1)}$(".stuff-pick-right[value='"+e+"']").css("border-style","solid").css("border-color","white"),$(".stuff-type-left-img[value='"+e+"']").css("background-image","url()"),t&&renderStuff()}function stuffColorChangeBtn(e,t){for(var o=!1,a=0;a<stuff_picker.length;a++)stuff_picker[a].type_id==t&&(0==e&&(stuff_picker[a].color_code_0?$(".btn-color-1").css("background-color",stuff_picker[a].color_code_0):(console.log("stuffColorChangeBtn set btn-color-1 empty"),$(".btn-color-1").css("background-color",""))),1==e&&(stuff_picker[a].color_code_1?$(".btn-color-2").css("background-color",stuff_picker[a].color_code_1):(console.log("stuffColorChangeBtn set btn-color-2 empty"),$(".btn-color-2").css("background-color",""))),2==e&&(stuff_picker[a].color_code_2?$(".btn-color-3").css("background-color",stuff_picker[a].color_code_2):(console.log("stuffColorChangeBtn set btn-color-3 empty"),$(".btn-color-3").css("background-color",""))),o=!0);o||(console.log("TYPE NOT EXISTED"),$(".color-picker-render").css("display","none"),$(".btn-color-1").css("background-color",""),$(".btn-color-2").css("background-color",""),$(".btn-color-3").css("background-color",""))}function setStuffTypeColor(e,t,o,a){setStuffTypeColorFlow(e,t,o,a,function(){renderStuff()})}function setStuffTypeColorFlow(e,t,o,a,r){$.ajax({url:"/api/v1/creates/find_color",type:"get",dataType:"json",data:{color_id:e},success:function(e){if(e){if($(".stuff-pick-right[value='"+o+"']").css("border","5px").css("border-style","solid").css("border-color",e.data),$(".stuff-type-right-img[value='"+o+"']").css("top","3px").css("left","3px"),0==t){for(var a=0;a<stuff_picker.length;a++)stuff_picker[a].type_id==o&&(stuff_picker[a].color_code_0=e.data,stuff_picker[a].color_code_0_name=e.name,stuff_picker[a].color_code_0_price=e.color_price);stuffColorChangeBtn(t,o)}if(1==t){for(var a=0;a<stuff_picker.length;a++)stuff_picker[a].type_id==o&&(stuff_picker[a].color_code_1=e.data,stuff_picker[a].color_code_1_name=e.name,stuff_picker[a].color_code_1_price=e.color_price);stuffColorChangeBtn(t,o)}if(2==t){for(var a=0;a<stuff_picker.length;a++)stuff_picker[a].type_id==o&&(stuff_picker[a].color_code_2=e.data,stuff_picker[a].color_code_2_name=e.name,stuff_picker[a].color_code_2_price=e.color_price);stuffColorChangeBtn(t,o)}r()}},error:function(){console.log("API find_stuff ERROR !!")}})}function set_active_stuff(e){for(var t=0;t<stuff_picker.length;t++)$("#stuff_"+stuff_picker[t].stuff_id).removeClass("active");$("#stuff_"+e).addClass("active")}function set_stuff_picker(e,t){set_active_stuff(t);var o=0;""!=e.data.stuff_additional_price&&(o=parseFloat(e.data.stuff_additional_price));for(var a=!0,r=0;r<stuff_picker.length;r++)stuff_picker[r].type_id==e.data.stuff_type_id&&(stuff_picker[r].stuff_id=t,stuff_picker[r].price=e.data.stuff_price,stuff_picker[r].stuff_name=e.data.stuff.name,stuff_picker[r].additional_price=o,a=!1);a&&stuff_picker.push({type_id:e.data.stuff_type_id,stuff_id:t,stuff_type_name:e.data.stuff_type_name,stuff_name:e.data.stuff.name,stuff_type_priority:e.data.stuff_type_priority,price:e.data.stuff_price,additional_price:o,color_ratio_0:e.data.color_ratio_0,color_ratio_1:e.data.color_ratio_1,color_ratio_2:e.data.color_ratio_2})}function stuff_click_type(e,t){set_active_stuff(e),1==t&&create_init(e),$.ajax({url:"/api/v1/creates/find_stuff_texture_size",type:"get",dataType:"json",data:{stuff_id:e},success:function(e){if(e){if(e.texture.length>0){e.texture.sort(function(e,t){return parseFloat(e.priority)-parseFloat(t.priority)}),$("#texture-picker").empty();for(var t=0;t<e.texture.length;t++)$("#texture-picker").append("<a class='pull-left texture'><div data-balloon='"+e.texture[t].name+"' data-balloon-pos='down' ><div class='create-circle-texture '  onclick='setTexture("+e.texture[t].id+")' value="+e.texture[t].id+"></div></div></a>"),$(".create-circle-texture[value='"+e.texture[t].id+"']").css("background-image",'url("'+e.texture[t].img+'")'),0==t&&setTexture(e.texture[t].id)}else $("#texture-picker").empty();if(e.size.length>0){stuff_price=[];for(var t=0;t<e.size.length;t++)tmp={id:e.size[t].id,name:e.size[t].name,sex:e.size[t].sex,price:e.size[t].base_price,priority:e.size[t].priority,add_option_price:e.size[t].add_option_price,pattern_price:e.size[t].pattern_price},stuff_price.push(tmp);$("#stuff_calculate_price").css("display","")}e.promotion&&(document.getElementById("promotion_img").src=e.promotion,$("#stuff_type_promotion").css("display",""))}},error:function(){console.log("API find_stuff_texture ERROR !!")}})}function stuff_click(e,t){$.ajax({url:"/api/v1/creates/find_stuff",type:"get",dataType:"json",data:{stuff_id:e},success:function(o){if(o){"TYPE"==o.data.stuff_type_name&&stuff_click_type(e,t);var a=!0;if("LOGO"!=o.data.stuff_type_name){if(set_stuff_picker(o,e),1==t&&"TYPE"!=o.data.stuff_type_name&&stuffColorSelect(current_type_id,e),"POCKET"==o.data.stuff_type_name)for(var r=0;r<stuff_picker.length;r++)if("LOGO"==stuff_picker[r].stuff_type_name){delete stuff_picker[r].logo_front_l;break}"TYPE"!=o.data.stuff_type_name&&"LOGO"!=o.data.stuff_type_name&&(o.color_layer_0?color_render.push({color_layer_id:o.color_layer_0.id,layer:0,type_id:o.type_id,active:t},function(){console.log("finished processing COLOR 0 of ",o.data.stuff_type_name)}):console.log(o.data.stuff_type_name+" Color layer 0 not found !"),o.color_layer_1?color_render.push({color_layer_id:o.color_layer_1.id,layer:1,type_id:o.type_id,active:t},function(){console.log("finished processing COLOR 1 of ",o.data.stuff_type_name)}):console.log(o.data.stuff_type_name+" Color layer 1 not found !"),o.color_layer_2?color_render.push({color_layer_id:o.color_layer_2.id,layer:2,type_id:o.type_id,active:t},function(){console.log("finished processing  COLOR 2 of ",o.data.stuff_type_name)}):console.log(o.data.stuff_type_name+" Color layer 2 not found !"))}else"LOGO"==o.data.stuff_type_name&&(logoUpload(o,e),a=!1);a&&$(".stuff-type-left-img[value='"+o.data.stuff_type_id+"']").css("background-image","url("+o.data.stuff_img+")").css("background-size","contain").css("background-repeat","no-repeat")}},error:function(){console.log("API find_stuff ERROR !!")}})}function logoUpload(e,t){current_logo=e,current_logo_stuff_id=t,$("#create_policy").modal("show")}function drawLogo(e,t,o,a,r,i,c){var l=new Image;l.onload=function(){var e=document.getElementById("tmp_canvas"),_=e.getContext("2d");_.clearRect(0,0,e.width,e.height),"logo_right_arm"==i?(_.save(),_.rotate(15*Math.PI/180),_.drawImage(l,t,o,a,r),_.restore()):"-logo_right_arm"==i?(_.save(),_.rotate(-15*Math.PI/180),_.drawImage(l,t,o,a,r),_.restore()):"logo_left_arm"==i?(_.save(),_.rotate(-15*Math.PI/180),_.drawImage(l,t,o,a,r),_.restore()):"-logo_left_arm"==i?(_.save(),_.rotate(15*Math.PI/180),_.drawImage(l,t,o,a,r),_.restore()):_.drawImage(l,t,o,a,r);var s=_.getImageData(0,0,e.width,e.height),n=document.getElementById("order_canvas"),f=n.getContext("2d");convertCanvasToImage(n,function(e){f.drawImage(e,0,0);for(var t=f.getImageData(0,0,n.width,n.height),o=0;o<s.data.length;o+=4)s.data[o+3]=t.data[o+3]*s.data[o+3];var a=document.getElementById("tmp_canvas"),r=a.getContext("2d");r.clearRect(0,0,a.width,a.height),r.putImageData(s,0,0),convertCanvasToImage(a,function(e){ctx.drawImage(e,0,0),c()})})},l.src=window.location.origin+e}function renderLogo(e){for(var t=!1,o=0;o<stuff_picker.length;o++)if("LOGO"==stuff_picker[o].stuff_type_name){stuff_picker[o].logo_front_l&&logo_q.push({data:[stuff_picker[o].logo_front_l.img_path,460,220,100,100,"logo_front_l",stuff_picker[o].logo_front_l.width,stuff_picker[o].logo_front_l.height]},function(){console.log("finished processing : logo_front_l ")}),stuff_picker[o].logo_front_r&&logo_q.push({data:[stuff_picker[o].logo_front_r.img_path,240,220,100,100,"logo_front_r",stuff_picker[o].logo_front_r.width,stuff_picker[o].logo_front_r.height]},function(){console.log("finished processing : logo_front_r ")}),stuff_picker[o].logo_left_arm&&(logo_q.push({data:[stuff_picker[o].logo_left_arm.img_path,570,340,100,100,"logo_left_arm",stuff_picker[o].logo_left_arm.width,stuff_picker[o].logo_left_arm.height]},function(){console.log("finished processing : logo_left_arm ")}),logo_q.push({data:[stuff_picker[o].logo_left_arm.img_path,890,-70,100,100,"-logo_left_arm",stuff_picker[o].logo_left_arm.width,stuff_picker[o].logo_left_arm.height]},function(){console.log("finished processing : logo_left_arm BACK")})),stuff_picker[o].logo_right_arm&&(logo_q.push({data:[stuff_picker[o].logo_right_arm.img_path,120,140,100,100,"logo_right_arm",stuff_picker[o].logo_right_arm.width,stuff_picker[o].logo_right_arm.height]},function(){console.log("finished processing : logo_right_arm ")}),logo_q.push({data:[stuff_picker[o].logo_right_arm.img_path,1335,545,100,100,"-logo_right_arm",stuff_picker[o].logo_right_arm.width,stuff_picker[o].logo_right_arm.height]},function(){console.log("finished processing : logo_right_arm BACK")})),stuff_picker[o].logo_back_shouder&&logo_q.push({data:[stuff_picker[o].logo_back_shouder.img_path,1151,90,100,75,"logo_back_shouder",stuff_picker[o].logo_back_shouder.width,stuff_picker[o].logo_back_shouder.height]},function(){console.log("finished processing : logo_back_shouder ")}),stuff_picker[o].logo_back_center&&logo_q.push({data:[stuff_picker[o].logo_back_center.img_path,1101,200,200,133,"logo_back_center",stuff_picker[o].logo_back_center.width,stuff_picker[o].logo_back_center.height]},function(){console.log("finished processing : logo_back_center ")}),stuff_picker[o].logo_top_pocket&&logo_q.push({data:[stuff_picker[o].logo_top_pocket.img_path,470,185,70,30,"logo_top_pocket",stuff_picker[o].logo_top_pocket.width,stuff_picker[o].logo_top_pocket.height]},function(){console.log("finished processing : logo_top_pocket ")}),stuff_picker[o].logo_center_pocket&&logo_q.push({data:[stuff_picker[o].logo_center_pocket.img_path,470,263,60,60,"logo_center_pocket",stuff_picker[o].logo_center_pocket.width,stuff_picker[o].logo_center_pocket.height]},function(){console.log("finished processing : logo_center_pocket ")}),stuff_picker[o].logo_top_pocket_r&&logo_q.push({data:[stuff_picker[o].logo_top_pocket_r.img_path,270,185,70,30,"logo_top_pocket_r",stuff_picker[o].logo_top_pocket_r.width,stuff_picker[o].logo_top_pocket_r.height]},function(){console.log("finished processing : logo_top_pocket_r ")}),stuff_picker[o].logo_center_pocket_r&&logo_q.push({data:[stuff_picker[o].logo_center_pocket_r.img_path,270,263,60,60,"logo_center_pocket_r",stuff_picker[o].logo_center_pocket_r.width,stuff_picker[o].logo_center_pocket_r.height]},function(){console.log("finished processing : logo_center_pocket_r ")}),t=!0;break}t||console.log("LOGO NOT FOUND !"),e()}function addTexture(e,t,o){$.ajax({url:"/api/v1/creates/find_texture",type:"get",dataType:"json",data:{texture_id:t},success:function(t){t&&(stuff_picker[e].texture_id=t.data.id,stuff_picker[e].texture_name=t.data.name,stuff_picker[e].texture_price=t.data.price,stuff_picker[e].texture_desc=t.data.desc,stuff_picker[e].texture_img=t.img,stuff_picker[e].texture_consumption=t.data.consumption,stuff_picker[e].status_flexible=t.data.status_flexible,stuff_picker[e].status_thick=t.data.status_thick,stuff_picker[e].status_velvety=t.data.status_velvety),o(e)},error:function(t){console.log(t),o(e)}})}function setTexture(e){for(var t=!1,o=0;o<stuff_picker.length;o++)if("TYPE"==stuff_picker[o].stuff_type_name){addTexture(o,e,function(e){renderPreviewTexture(stuff_picker[e])}),t=!0;break}t||$("#type_first").modal("show")}function renderPreviewTexture(e){$("#stuff_texture_preview").css("display",""),$("#stuff_texture_preview_name").empty(),$("#stuff_texture_preview_name").append(e.texture_name),$("#stuff_texture_preview_desc").empty(),$("#stuff_texture_preview_desc").append(e.texture_desc),$("#stuff_texture_preview_img").css("background-image","url("+e.texture_img+")").css("background-repeat","no-repeat").css("background-size","cover"),5==e.status_flexible&&$("#flexible_star5").prop("checked",!0),4==e.status_flexible&&$("#flexible_star4").prop("checked",!0),3==e.status_flexible&&$("#flexible_star3").prop("checked",!0),2==e.status_flexible&&$("#flexible_star2").prop("checked",!0),1==e.status_flexible&&$("#flexible_star1").prop("checked",!0),5==e.status_thick&&$("#thick_star5").prop("checked",!0),4==e.status_thick&&$("#thick_star4").prop("checked",!0),3==e.status_thick&&$("#thick_star3").prop("checked",!0),2==e.status_thick&&$("#thick_star2").prop("checked",!0),1==e.status_thick&&$("#thick_star1").prop("checked",!0),5==e.status_velvety&&$("#velvety_star5").prop("checked",!0),4==e.status_velvety&&$("#velvety_star4").prop("checked",!0),3==e.status_velvety&&$("#velvety_star3").prop("checked",!0),2==e.status_velvety&&$("#velvety_star2").prop("checked",!0),1==e.status_velvety&&$("#velvety_star1").prop("checked",!0)}function calculateLogoPrice(e){for(var t=0,o=0;o<stuff_picker.length;o++)if("LOGO"==stuff_picker[o].stuff_type_name){for(var a=0,r=0,i=0,c=0,l=0,_=0,s=0;s<logo_static_value.logo_static_value.length;s++)"A"==logo_static_value.logo_static_value[s].name&&(a=logo_static_value.logo_static_value[s].value),"B"==logo_static_value.logo_static_value[s].name&&(r=logo_static_value.logo_static_value[s].value),"C"==logo_static_value.logo_static_value[s].name&&(i=logo_static_value.logo_static_value[s].value),"D"==logo_static_value.logo_static_value[s].name&&(c=logo_static_value.logo_static_value[s].value),"E"==logo_static_value.logo_static_value[s].name&&(l=logo_static_value.logo_static_value[s].value),"F"==logo_static_value.logo_static_value[s].name&&(_=logo_static_value.logo_static_value[s].value);for(var n=["logo_back_center","logo_back_shouder","logo_front_l","logo_front_r","logo_left_arm","logo_right_arm","logo_top_pocket","logo_center_pocket","logo_top_pocket_r","logo_center_pocket_r"],f=0;f<n.length;f++)if(stuff_picker[o][n[f]]){var u=stuff_picker[o][n[f]].width,d=stuff_picker[o][n[f]].height,p=stuff_picker[o][n[f]].color_number,g=0;"lace"==stuff_picker[o][n[f]].logo_type?(g=logo_block_lace(u,d,p,a,e)+logo_per_lace(u,d,p,r,i),console.log("LOGO TYPE ",stuff_picker[o][n[f]].logo_type),console.log("PRICE logo_block_lace = ",logo_block_lace(u,d,p,a,e)),console.log("PRICE logo_per_lace = ",logo_per_lace(u,d,p,r,i)),console.log("width  = ",u),console.log("height  = ",d),console.log("color  = ",p),console.log("logo_value_b  = ",r),console.log("logo_value_c  = ",i)):"screen"==stuff_picker[o][n[f]].logo_type&&(g=logo_block_screen(u,d,p,c,e)+logo_per_screen(u,d,p,l,_)),t+=g}break}return t}function calculatePrice(e){console.log(""),price_report={};for(var t=[],o=0;o<e.length;o++){for(var a={},r=0,i=0,c=0,l=0,_=0;_<stuff_picker.length;_++)if("TYPE"==stuff_picker[_].stuff_type_name){i=stuff_picker[_].additional_price,c=stuff_picker[_].texture_price,l=stuff_picker[_].texture_consumption;break}for(var _=0;_<stuff_picker.length;_++)if("TYPE"!=stuff_picker[_].stuff_type_name&&"LOGO"!=stuff_picker[_].stuff_type_name){var s=0;stuff_picker[_].color_code_0_price&&(s+=stuff_picker[_].color_code_0_price*stuff_picker[_].color_ratio_0),stuff_picker[_].color_code_1_price&&(s+=stuff_picker[_].color_code_1_price*stuff_picker[_].color_ratio_1),stuff_picker[_].color_code_2_price&&(s+=stuff_picker[_].color_code_2_price*stuff_picker[_].color_ratio_2);var n={};n.color_code_0_price=stuff_picker[_].color_code_0_price,n.color_code_1_price=stuff_picker[_].color_code_1_price,n.color_code_2_price=stuff_picker[_].color_code_2_price,n.color_ratio_0=stuff_picker[_].color_ratio_0,n.color_ratio_1=stuff_picker[_].color_ratio_1,n.color_ratio_2=stuff_picker[_].color_ratio_2,n.fabric_price=c,n.color_factor=s,n.stuff_texture_consumption=l,n.consumption=stuff_picker[_].price,n.size_factor=e[o].price,n.static_price_per_stuff=stuff_picker[_].additional_price,a[stuff_picker[_].stuff_type_name]=n;var f=(c+s)*l*stuff_picker[_].price*e[o].price+stuff_picker[_].additional_price;r+=f}var u=r+i,d=0;document.getElementById("create_add_height").checked&&(console.log("add_option_price = "+e[o].add_option_price),d=e[o].add_option_price*u/100),u=Math.round(u+d),a.add_option_price=d,a.wage=i,a.base_price=r,price_report[e[o].name+"_"+e[o].sex]=a,t.push({name:e[o].name,price:u,sex:e[o].sex,priority:e[o].priority})}return t}function logo_block_lace(e,t,o,a,r){return e*t*(o*a)/r}function logo_per_lace(e,t,o,a,r){return e*t*a*(1+o/r)}function logo_block_screen(e,t,o,a,r){return e*t*(o*a)/r}function logo_per_screen(e,t,o,a,r){return e*t*a*(1+o/r)}function renderPrice(){$("#calculate_list_male").empty(),$("#calculate_list_female").empty();var e=calculatePrice(stuff_price);e.sort(function(e,t){return parseFloat(e.priority)-parseFloat(t.priority)});for(var t=0;t<e.length;t++)"male"==e[t].sex?$("#calculate_list_male").append("<div class='row'><div class='col-xs-6'style='padding-left: 30px'>"+e[t].name+"</div><div class='col-xs-6' style='padding-right: 30px' align='right'>"+e[t].price+"</div></div>"):"female"==e[t].sex&&$("#calculate_list_female").append("<div class='row'><div class='col-xs-6'style='padding-left: 30px'>"+e[t].name+"</div><div class='col-xs-6' style='padding-right: 30px' align='right'>"+e[t].price+"</div></div>")}function amountPrice(){var e=[],t=calculatePrice(stuff_price),o=0;stuff_price.sort(function(e,t){return parseFloat(e.priority)-parseFloat(t.priority)}),t.sort(function(e,t){return parseFloat(e.priority)-parseFloat(t.priority)});for(var a=0;a<t.length;a++)for(var r=0;r<stuff_price.length;r++){var i=document.getElementsByName(stuff_price[r].name+"_"+stuff_price[r].sex)[0].value;if(stuff_price[r].name+stuff_price[r].sex==t[a].name+t[a].sex&&void 0!=i){e.push({size:stuff_price[r].name+"_"+stuff_price[r].sex,amount:document.getElementsByName(stuff_price[r].name+"_"+stuff_price[r].sex)[0].value,price_per_unit:t[a].price}),o+=i*t[a].price;break}}return e}function renderLoading(e,t){e?(console.log("renderLoading ",e),$("#order_canvas").fadeTo("fast",.2),$("#loading_gif").fadeIn(10,function(){}),t()):(console.log("renderLoading ",e),$("#order_canvas").fadeTo("fast",1),$("#loading_gif").fadeOut(10),t())}function hex2rgb(e){return r=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),r?r.slice(1,4).map(function(e){return parseInt(e,16)}):(r=e.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i),r?r.slice(1,4).map(function(e){return 17*parseInt(e,16)}):null)}function convertCanvasToImage(e,t){var o=new Image;o.src=e.toDataURL("image/png"),o.onload=function(){t(o)}}function renderWaterMask(){var e=new Image;e.onload=function(){var t=document.getElementById("order_canvas"),o=t.getContext("2d");o.drawImage(e,0,0)},e.src=$("#order_canvas").data("water-mask")}function prepare_art_work(){$("#img_base_64").val(canvas.toDataURL("image/png"))}function renderStuff(){ctx.clearRect(0,0,canvas.width,canvas.height),renderLoading(!0,function(){stuff_picker.sort(function(e,t){return parseFloat(e.stuff_type_priority)-parseFloat(t.stuff_type_priority)});for(var e=0;e<stuff_picker.length;e++)q.push({data:[stuff_picker[e].stuff_id,stuff_picker[e].stuff_type_name,stuff_picker[e].color_code_0,stuff_picker[e].color_code_1,stuff_picker[e].color_code_2]},function(e,t,o,a,r,i,c,l){var _=!0;if(void 0!=o&&null!=i){var s=hex2rgb(o),n=document.getElementById("tmp_canvas"),f=n.getContext("2d");f.clearRect(0,0,n.width,n.height),f.drawImage(i,0,0);for(var u=f.getImageData(0,0,i.width,i.height),d=0;d<u.data.length;d+=4)u.data[d]=s[0]*(u.data[d]/255),u.data[d+1]=s[1]*(u.data[d+1]/255),u.data[d+2]=s[2]*(u.data[d+2]/255);f.clearRect(0,0,n.width,n.height),f.putImageData(u,0,0),convertCanvasToImage(n,function(e){ctx.drawImage(e,0,0)}),_=!1,console.log("finished processing color:",t," ","img 1")}if(void 0!=a&&null!=c){var p=hex2rgb(a),g=document.getElementById("tmp_canvas"),m=g.getContext("2d");m.clearRect(0,0,g.width,g.height),m.drawImage(c,0,0);for(var h=m.getImageData(0,0,c.width,c.height),d=0;d<h.data.length;d+=4)h.data[d]=p[0]*(h.data[d]/255),h.data[d+1]=p[1]*(h.data[d+1]/255),h.data[d+2]=p[2]*(h.data[d+2]/255);m.clearRect(0,0,g.width,g.height),m.putImageData(h,0,0),convertCanvasToImage(g,function(e){ctx.drawImage(e,0,0)}),_=!1,console.log("finished processing color:",t," ","img 2")}if(void 0!=r&&null!=l){var k=hex2rgb(r),v=document.getElementById("tmp_canvas"),y=v.getContext("2d");y.clearRect(0,0,v.width,v.height),y.drawImage(l,0,0);for(var $=y.getImageData(0,0,l.width,l.height),d=0;d<h.data.length;d+=4)$.data[d]=k[0]*($.data[d]/255),$.data[d+1]=k[1]*($.data[d+1]/255),$.data[d+2]=k[2]*($.data[d+2]/255);y.clearRect(0,0,v.width,v.height),y.putImageData($,0,0),convertCanvasToImage(v,function(e){ctx.drawImage(e,0,0)}),_=!1,console.log("finished processing color:",t," ","img 2")}_&&null!=l&&ctx.drawImage(l,0,0),console.log("finished processing :",t)})})}function setImgToSummary(){convertCanvasToImage(canvas,function(e){$(".summaryModal_img").empty(),$(".summaryModal_img").append("<img src='"+e.src+"' style='width: 100%'>"),console.log("===== setImgToSummary =====")})}function create_init(e){loadProfitData(),loadLogoStaticValue(),$.ajax({url:"/api/v1/creates/prepare_default_stuff",type:"get",dataType:"json",data:{type_id:e},success:function(e){if(e){var t=e.type_side.id,o=e.type_side.name;if(t&&o&&checkNav(o,t),e.type){var t=e.type.id;stuff_click(t,!1)}if(e.body){var a=e.body.id;stuff_click(a,!1)}else resetSubBar(e.body_type_id,!1);if(e.neck){var r=e.neck.id;stuff_click(r,!1)}else resetSubBar(e.neck_type_id,!1);if(e.sleeve){var i=e.sleeve.id;stuff_click(i,!1)}else resetSubBar(e.sleeve_type_id,!1);if(e.placket){var c=e.placket.id;stuff_click(c,!1)}else resetSubBar(e.placket_type_id,!1);if(e.botton){var l=e.botton.id;stuff_click(l,!0)}else resetSubBar(e.botton_type_id,!1)}else console.log("API prepare_default_stuff cant find stuff")},error:function(e){console.log(e)}})}function loadProfitData(){$.ajax({url:"/api/v1/creates/stuff_profit",type:"get",dataType:"json",success:function(e){e&&(stuff_profit=e)},error:function(e){console.log(e)}})}function loadLogoStaticValue(){$.ajax({url:"/api/v1/creates/logo_static_value",type:"get",dataType:"json",success:function(e){e&&(logo_static_value=e)},error:function(e){console.log(e)}})}var current_type_id=0,stuff_picker=[],stuff_price=[],stuff_profit,logo_static_value,price_report={},price_amount_report={},color_render=async.queue(function(e,t){setStuffTypeColorFlow(e.color_layer_id,e.layer,e.type_id,e.active,t)},1);color_render.drain=function(){console.log("all color_render have been processed"),renderStuff()};var current_logo=null,current_logo_stuff_id=null,logo_q=async.queue(function(e,t){var o=e.data[0],a=e.data[1],r=e.data[2],i=e.data[3],c=e.data[4],l=e.data[5],_=parseFloat(e.data[6]),s=parseFloat(e.data[7]);console.log("name :",l),console.log("width :",_),console.log("height :",s),_>=s?c=s*i/_:i=_*c/s,console.log("renderX ",i),console.log("renderY ",c),drawLogo(o,a,r,i,c,l,t)},1);logo_q.drain=function(){console.log("All Logo has been render")};var q=async.queue(function(e,t){var o=e.data[0],a=e.data[1],r=e.data[2],i=e.data[3],c=e.data[4];"LOGO"==a?renderLogo(function(){t(o,a,r,i,null,null)}):$.ajax({url:"/api/v1/creates/find_stuff",type:"get",dataType:"json",data:{stuff_id:o},success:function(e){if(e){var l=e.data.stuff_product_img;if(l){var _=new Image;_.onload=function(){if(""!=e.data.stuff_product_img_two){var l=e.data.stuff_product_img_two,s=new Image;s.onload=function(){if(""!=e.data.stuff_product_img_three){var l=e.data.stuff_product_img_three,n=new Image;n.onload=function(){t(o,a,r,i,c,_,s,n)},n.src=l}else t(o,a,r,i,c,_,s,null)},s.src=l}else t(o,a,r,i,c,_,null,null)},_.src=l}}},error:function(e){console.log(e)}})},1);q.drain=function(){console.log("all STUFF have been processed"),renderLoading(!1,function(){renderWaterMask(),prepare_art_work()}),renderPrice()};var canvas=document.getElementById("order_canvas"),ctx=canvas.getContext("2d");$(document).ready(function(){create_init(-99),document.getElementById("logo_upload").onchange=function(){var e=this.value.split("\\");document.getElementById("upload_file_name").innerHTML=e[e.length-1]},$("#create_customer_input_form").change(function(){document.getElementById("total_amount").innerHTML="",document.getElementById("price_per_amount").innerHTML="",document.getElementById("total_price").innerHTML="";for(var e=calculatePrice(stuff_price),t=0,o=0,a={},r=0;r<e.length;r++)for(var i=0;i<stuff_price.length;i++){var c=document.getElementsByName(stuff_price[i].name+"_"+stuff_price[i].sex)[0].value;if(stuff_price[i].name+stuff_price[i].sex==e[r].name+e[r].sex&&""!=c&&"0"!=c){o+=parseInt(c);var l=calculateLogoPrice(c),_=e[r].price+stuff_price[i].pattern_price/c+l;t+=c*_;var s=stuff_price[i].name+"_"+stuff_price[i].sex;price_report[s]&&(price_report[s].pattern_price=stuff_price[i].pattern_price,price_report[s].amount=c,price_report[s].all_logo_price=l,price_report[s]["pattern_price / input_amount"]=stuff_price[i].pattern_price/c,price_report[s].current_price=_,price_report[s].total_amount_price=c*_,a[s]=price_report[s]);break}}price_amount_report.all_stuff_price=a;var n=0,f=stuff_profit.stuff_profit;f.sort(function(e,t){return parseFloat(e.amount)-parseFloat(t.amount)});for(var u=0;u<f.length;u++)if(o<=f[u].amount){n=f[u].profit;break}console.log("profit = ",n),console.log("total_amount = ",o),console.log("price_before_profit = ",t),price_amount_report.profit=n,price_amount_report.price_before_profit=t,t*=n,price_amount_report.total_price=t,document.getElementById("total_amount").innerHTML=Math.round(o)+" \u0e15\u0e31\u0e27",document.getElementById("total_price").innerHTML=Math.round(t)+".- BAHT",0!=o?document.getElementById("price_per_amount").innerHTML=Math.round(t/o)+".- BAHT":document.getElementById("price_per_amount").innerHTML="0.- BAHT"}),$("#make_order").click(function(){if(setImgToSummary(),document.getElementById("total_price").innerHTML="0.- BAHT",stuff_picker.length>0){for(var e=-100,t=0;t<stuff_picker.length;t++)if("TYPE"==stuff_picker[t].stuff_type_name){e=stuff_picker[t].stuff_id;break}e!=-100?$.ajax({url:"/api/v1/creates/find_stuff_size",type:"get",dataType:"json",data:{stuff_id:e},success:function(e){if(e){if($("#stuff_size_input").empty(),e.data_stuffSize_male.length>0){$("#stuff_size_input").append("<div class='col-xs-12 col-sm-12 col-md-12 stuff-size-inline'><h4>\u0e0a\u0e32\u0e22</h4></div>");for(var t=0;t<e.data_stuffSize_male.length;t++)$("#stuff_size_input").append("<div class='col-xs-6 col-sm-6 col-md-4 stuff-size-inline'> <div class='stuff-inline' style='width: 30px'>"+e.data_stuffSize_male[t].name+" : </div> <input class='stuff-inline' type='number' min='0' name='"+e.data_stuffSize_male[t].name+"_"+e.data_stuffSize_male[t].sex+"' id='input-stuff-size-"+e.data_stuffSize_male[t].stuff_id+"' style='width: 50px'> </div> ");
}if(e.data_stuffSize_female.length>0){$("#stuff_size_input").append("<div class='col-xs-12 col-sm-12 col-md-12 stuff-size-inline'><h4>\u0e2b\u0e0d\u0e34\u0e07</h4></div>");for(var t=0;t<e.data_stuffSize_female.length;t++)$("#stuff_size_input").append("<div class='col-xs-6 col-sm-6 col-md-4 stuff-size-inline'> <div class='stuff-inline' style='width: 30px'>"+e.data_stuffSize_female[t].name+" : </div> <input class='stuff-inline' type='number' min='0' name='"+e.data_stuffSize_female[t].name+"_"+e.data_stuffSize_female[t].sex+"' id='input-stuff-size-"+e.data_stuffSize_female[t].stuff_id+"' style='width: 50px'> </div> ")}$("#summaryModal").modal("show")}},error:function(){console.log("API find_stuff_size ERROR !!")}}):$("#incomplete_modal").modal("show")}else $("#incomplete_modal").modal("show")}),$("#make_order_amount").click(function(){console.log("make_order_amount")}),$("#make_order_address").on("click",function(){console.log("make_order_address");var e=$("#first_name").val(),t=$("#email").val(),o=$("#tel").val(),a=$("#address").val(),r=$("#company_name").val(),i=$("#company_branch").val(),c=$("#tax_identification_number").val(),l=stuff_picker,_=stuff_price,s=amountPrice(),n=$("#current_admin_user_email").val(),f="";if(document.getElementById("create_add_height").checked&&(f="\u0e40\u0e1e\u0e34\u0e48\u0e21\u0e04\u0e27\u0e32\u0e21\u0e22\u0e32\u0e27\u0e40\u0e2a\u0e37\u0e49\u0e2d"),""==t||""==o)$("#create-address-alert").modal("show");else{$("#addressModal").modal("hide");var u={first_name:e,email:t,tel:o,address:a,company_name:r,company_branch:i,tax_identification_number:c,estimate_cost:JSON.stringify(s),stuff_picker:JSON.stringify(l),base_price:JSON.stringify(_),option_price_details:f,price_amount_report:JSON.stringify(price_amount_report),current_admin_user_email:n};console.log("========= order_data ========="),console.log(u),$.ajax({url:"/api/v1/creates/make_order",type:"post",dataType:"json",data:u,success:function(e){if(e){console.log("make_order_data"),console.log(e);for(var t=document.getElementById("order_canvas"),o=t.toDataURL(),a=atob(o.split(",")[1]),r=[],i=0;i<a.length;i++)r.push(a.charCodeAt(i));var c=new Blob([new Uint8Array(r)],{type:"image/png"}),l=new FormData;l.append("img",c),l.append("order_id",e.order_id),$.ajax({url:"/api/v1/creates/save_order_img",method:"POST",data:l,processData:!1,contentType:!1,success:function(e){$("#addressModal").modal("hide"),1==e.status?$("#thxModal").modal("show"):$("#problemModal").modal("show")},error:function(e){console.log(e),console.log("API save_order_img ERROR !!")}})}},error:function(e){console.log(e),console.log("API make_order ERROR !!")}})}});var e=null,t=null;$("#create-logo-upload-form").change(function(){$("#expect_logo_width").text(Math.round(.39*$("#logo_width").val()*200)+" pixel"),t&&(Math.round(.39*$("#logo_width").val()*200)<=t?$("#logo_width").css("box-shadow","0 0 5px rgba(94, 255, 30, 1)"):$("#logo_width").css("box-shadow","0 0 5px rgba(255, 0, 0, 1)")),$("#expect_logo_height").text(Math.round(.39*$("#logo_height").val()*200)+" pixel"),e&&(Math.round(.39*$("#logo_height").val()*200)<=e?$("#logo_height").css("box-shadow","0px 0px 5px rgba(94, 255, 30, 1)"):$("#logo_height").css("box-shadow","0px 0px 5px rgba(255, 0, 0, 1)")),(file=$("#logo_upload")[0].files[0])||(document.getElementById("max_width_of_upload_file").innerHTML="",document.getElementById("max_height_of_upload_file").innerHTML="",$("#logo_width").val(0),$("#logo_height").val(0),$("#expect_logo_width").text(""),$("#expect_logo_height").text(""),$("#logo_height").css("box-shadow","0px 0px 5px rgba(255, 255, 255, 1)"),$("#logo_width").css("box-shadow","0px 0px 5px rgba(255, 255, 255, 1)"))}),$("#logo_upload").change(function(){var o,a,r=window.URL||window.webkitURL;(o=$("#logo_upload")[0].files[0])&&(a=new Image,a.onload=function(){console.log("logo_upload W : H = "+this.width+" : "+this.height),e=this.height,t=this.width,document.getElementById("max_width_of_upload_file").innerHTML="\u0e01\u0e27\u0e49\u0e32\u0e07 : "+t+"px",document.getElementById("max_height_of_upload_file").innerHTML="\u0e2a\u0e39\u0e07 : "+e+"px"},a.onerror=function(){alert("not a valid file: "+o.type)},a.src=r.createObjectURL(o))}),$("#logo_upload_btn").click(function(){if(""==$("#logo_upload").val()||"0"==$("#logo_width").val()||"0"==$("#logo_height").val()||void 0==$("input[name='color_number']:checked").val()||void 0==$("input[name='screen_lace']:checked").val())$("#upload_alert").modal("show");else{set_stuff_picker(current_logo,current_logo_stuff_id),console.log("width expect with 200dpi = ",Math.round(.39*$("#logo_width").val()*200)),console.log("height expect with 200dpi = ",Math.round(.39*$("#logo_height").val()*200));var e,t,o=Math.round(.39*$("#logo_width").val()*200),a=Math.round(.39*$("#logo_height").val()*200),r=window.URL||window.webkitURL;(e=$("#logo_upload")[0].files[0])&&(t=new Image,t.onload=function(){if(console.log("uploaded W : H = "+this.width+" : "+this.height),o>this.width||a>this.height)alert("\u0e23\u0e39\u0e1b\u0e20\u0e32\u0e1e \u0e01\u0e31\u0e1a \u0e02\u0e19\u0e32\u0e14\u0e44\u0e21\u0e48\u0e1c\u0e48\u0e32\u0e19\u0e02\u0e49\u0e2d\u0e01\u0e33\u0e2b\u0e19\u0e14 \u0e01\u0e27\u0e49\u0e32\u0e07 \u0e2a\u0e39\u0e07 "+this.width+" "+this.height);else if(o<=this.width||a<=this.height){var e=new FormData;e.append("img",$("#logo_upload")[0].files[0]),e.append("color_number",$("input[name='color_number']:checked").val()),e.append("logo_type",$("input[name='screen_lace']:checked").val()),e.append("logo_width",$("#logo_width").val()),e.append("logo_height",$("#logo_height").val()),$.ajax({url:"/api/v1/creates/save_logo_img",method:"POST",data:e,processData:!1,contentType:!1,success:function(e){if($("#logo_upload").val(""),e){for(var t=0;t<stuff_picker.length;t++)if("LOGO"==stuff_picker[t].stuff_type_name){stuff_picker[t][current_logo.data.stuff.name]={img_path:e.img_original,img_id:e.data.id,width:$("#logo_width").val(),height:$("#logo_height").val(),logo_type:e.data.logo_type,color_number:e.data.color_number},current_logo.data.stuff_type_id&&e.img_thumb&&$(".stuff-type-left-img[value='"+current_logo.data.stuff_type_id+"']").css("background-image","url("+e.img_thumb+")").css("background-size","contain").css("background-repeat","no-repeat").css("filter","invert(0)");break}renderStuff(),document.getElementById("upload_file_name").innerHTML="",document.getElementById("max_width_of_upload_file").innerHTML="",document.getElementById("max_height_of_upload_file").innerHTML="",$("#logo_upload_modal").modal("hide")}},error:function(e){console.log(e),console.log("API save_logo_img ERROR !!")}})}},t.onerror=function(){alert("Not a valid file: "+e.type)},t.src=r.createObjectURL(e))}}),$("#stuff_type_promotion_btn").click(function(){$("#promotion_modal").modal("show")}),$(".create-checkbox-position").on("change",function(){console.log($("input[name=create_pocket]:checked").val())}),$(".price_preview_header").on("click",function(){$(".stuff_calculate_price").slideToggle("slow")}),$(".texture_preview_header").on("click",function(){$(".stuff_texture_preview").slideToggle("slow")}),$(".create-plus-icon").on("click",function(){$("#sidebar-wrapper").css("display","block"),$("#subSlideBar").css("display","block"),$(".create-plus-icon").css("display","none"),$(".create-cancel-icon").css("display","block")}),$(".create-cancel-icon").on("click",function(){$("#sidebar-wrapper").css("display","none"),$("#subSlideBar").css("display","none"),$(".create-plus-icon").css("display","block"),$(".create-cancel-icon").css("display","none")})});